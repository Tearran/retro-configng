#!/bin/bash


#
# This script provides a Dialog box interface for managing Armbian configuration.
#


#
# check for root privileges
#
#if [[ $EUID != 0 ]]; then
#	echo "This tool requires root privileges. Try again with \"sudo \" please ..." >&2
#	sleep 2
#	exit 1
#fi


#
# load functions, Dynamic directory root
#
bin="$(dirname "${BASH_SOURCE[0]}")"
directory="$(cd "$bin/../" && pwd )"
file_name="$(basename "${BASH_SOURCE[0]}")"
filename="${file_name%.*}"
# Set the path to the mod directory
modpath=$(cd "$directory/lib" && pwd)
json_file="$directory/etc/armbian-config/retro-config.json" || exit 1
json_data=$(cat "$json_file")
libpath="$directory/lib"


#
# load Armbian information
#
[[ -f "/etc/armbian-release" ]] && source /etc/armbian-release
[[ -f "/etc/os-release" ]] && source /etc/os-release


#
# Define the options for the module    
#
declare -A options


#
# Load the module files
#
source_modules() {
    local modpath="$1"
    for file in "$modpath"/*.sh
        do
            if [[ -f "$file" ]]; then
                source "$file" 
            fi
        done
} 

if [[ -f "$HOME/.local/lib/config.its.sh" ]] ; then
    source "$libpath/config.its.sh"
else
    source_modules "$libpath/config.its"
fi

#
# Set the dialog command to whiptail or dialog
#
if command -v whiptail &> /dev/null
then
    dialog_cmd="whiptail"
elif command -v dialog &> /dev/null
then
    dialog_cmd="dialog"
else
echo -e "Error: Neither 'dialog' nor 'whiptail' is installed.\n  Please install whiptail for best of them and try again."
exit 1
fi


#
# Load Module mesaage
#
function see_use() {
    mod_message="Usage: ${0##*/} [options] [arguments] \n\nOptions:\n"
    # Iterate over the options
    for key in "${!options[@]}"; do
        # Split the key into function_name and type
        IFS=',' read -r function_name type <<< "$key"
        # If the type is 'long', append the option to the help message
        if [[ "$type" == "long" ]]; then
            #mod_message+=" ${options["$function_name,long"]}\n"
            mod_message+="  ${options["$function_name,disc"]}\n"
            mod_message+="  ${options["$function_name,use"]}\n"
        fi
    done

    echo -e "$mod_message"
}


#
# Show Help mesaage
#
[[ $1 == "--use" || $1 == "-u" ]] && see_use && exit 0;


#
# Load the TUI
while true; do
    clear
    generate_top_menu || exit 1
done

exit 0

